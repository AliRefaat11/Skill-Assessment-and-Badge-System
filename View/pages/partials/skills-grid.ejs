<section class="container mx-auto px-4 py-12">
  <!-- Search -->
  <div class="mb-6 max-w-xl">
    <input id="skill-search" type="search" placeholder="Search skills, categories, or topics..." class="input w-full" />
  </div>

  <div id="skills-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
    <!-- Filled by JS -->
    <div class="text-muted-foreground">Loading skills...</div>
  </div>

  <!-- Skill Assessments Dialog -->
  <div
    id="skill-assessments-dialog"
    data-dialog
    class="fixed inset-0 hidden items-center justify-center z-50"
  >
    <div class="absolute inset-0 bg-black/60" data-dialog-close></div>
    <div class="relative w-full max-w-2xl mx-auto bg-card border border-border rounded-2xl shadow-card p-6">
      <button class="absolute right-3 top-3 text-muted-foreground" data-dialog-close>
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      <div class="flex items-center justify-between mb-4">
        <h3 id="skill-dlg-title" class="text-xl font-bold text-foreground">Skill Assessments</h3>
        <button id="assign-skill-btn" class="inline-flex items-center px-4 py-2 rounded-md btn-primary">
          <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
          Assign
        </button>
      </div>
      <div id="skill-assessments-list" class="space-y-4 text-sm text-muted-foreground">
        <!-- Filled by JS -->
      </div>
      <div id="no-assessments" class="text-center py-8 hidden">
        <i data-lucide="info" class="w-8 h-8 mx-auto text-muted-foreground"></i>
        <p class="mt-2">No assessments available for this skill.</p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      let skillsData = [];
      let currentSkillId = null;
      const searchEl = document.getElementById('skill-search');
      const assignBtn = document.getElementById('assign-skill-btn');

      function debounce(fn, wait){
        let t;
        return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
      }

      async function fetchSkills(){
        try{
          const res = await fetch('/api/v1/skills');
          const payload = await res.json();
          if(!payload.success) throw new Error(payload.error || 'Failed to fetch skills');
          skillsData = payload.data || [];
          renderSkills(skillsData);
        }catch(err){
          document.getElementById('skills-grid').innerHTML = '<div class="text-danger">Failed to load skills</div>';
          console.error(err);
        }
      }

      function renderSkills(skills, query){
        const grid = document.getElementById('skills-grid');
        const q = (query || '').trim().toLowerCase();
        const filtered = q ? skills.filter(s=> (s.skillName||s.name||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q) || (s.category||'').toLowerCase().includes(q)) : skills;
        if(!filtered.length){
          grid.innerHTML = '<div class="text-muted-foreground">No skills found.</div>';
          return;
        }
        grid.innerHTML = filtered.map(s => (
          `<div tabindex="0" role="button" class="skill-card p-6 rounded-xl border border-border bg-card/10 cursor-pointer hover:shadow-glow flex flex-col justify-between" data-skill-id="${s._id}">
            <div>
              <div class="font-semibold text-foreground mb-2 text-base">${escapeHtml(s.skillName || s.name || 'Untitled')}</div>
              <div class="text-sm text-muted-foreground">${escapeHtml(s.description || '')}</div>
            </div>
            <div class="mt-6 text-sm text-muted-foreground">${s.category || ''}</div>
          </div>`
        )).join('');

        grid.querySelectorAll('[data-skill-id]').forEach(el=>{
          const id = el.getAttribute('data-skill-id');
          const title = el.querySelector('.font-semibold').textContent;
          el.addEventListener('click', ()=> openAssessments(id, title));
          el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openAssessments(id, title); } });
        });
      }

      async function openAssessments(skillId, skillName){
        currentSkillId = skillId;
        const dlg = document.getElementById('skill-assessments-dialog');
        const listEl = document.getElementById('skill-assessments-list');
        const noEl = document.getElementById('no-assessments');
        document.getElementById('skill-dlg-title').textContent = `Assessments — ${skillName}`;
        listEl.innerHTML = '<div class="text-muted-foreground">Loading…</div>';
        noEl.classList.add('hidden');
        dlg.classList.remove('hidden'); dlg.classList.add('flex');
        if (window.lucide && lucide.createIcons) lucide.createIcons();
        try{
          const res = await fetch(`/api/v1/assessments/skill/${skillId}`);
          const payload = await res.json();
          if(!payload.success){ throw new Error(payload.message || 'Failed to fetch assessments'); }
          const assessments = payload.data || [];
          if(!assessments.length){ listEl.innerHTML = ''; noEl.classList.remove('hidden'); return; }
          listEl.innerHTML = assessments.map(a => `
            <div class="p-3 rounded border border-border bg-white/5">
              <div class="flex items-center justify-between gap-4">
                <div>
                  <div class="text-sm text-foreground">Duration: ${a.duration} mins</div>
                  <div class="text-xs text-muted-foreground">Total Marks: ${a.TotalMarks}</div>
                  <div class="text-xs text-muted-foreground mt-1">Created: ${new Date(a.createdAt).toLocaleString()}</div>
                </div>
                <div class="flex-shrink-0">
                  <a href="/assessments/${a._id}" class="inline-block px-4 py-2 rounded-md btn-primary">View</a>
                </div>
              </div>
            </div>
          `).join('');
        }catch(err){
          listEl.innerHTML = '<div class="text-danger">Failed to load assessments</div>';
          console.error(err);
        }
      }

      async function assignSkillToLearner(){
        if(!currentSkillId){
          alert('No skill selected');
          return;
        }

        const btn = assignBtn;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>Assigning...';
        lucide.createIcons();

        try{
          // Get current learner ID
          const learnerRes = await fetch('/api/v1/learner/current', {
            credentials: 'include'
          });
          if(!learnerRes.ok) {
            const errorData = await learnerRes.json().catch(() => ({}));
            throw new Error(errorData.message || 'Failed to get learner information. Please make sure you are logged in as a learner.');
          }
          const learnerData = await learnerRes.json();
          // Handle both 'success' and 'status' response formats
          const isSuccess = learnerData.success === true || learnerData.status === 'success';
          if(!isSuccess || !learnerData.data){
            throw new Error('Learner not found. Please make sure you are logged in as a learner.');
          }
          const learnerId = learnerData.data._id;

          // Assign skill to learner
          const assignRes = await fetch('/api/v1/learnerSkills/assign', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
              learnerID: learnerId,
              skillID: currentSkillId
            })
          });

          const assignData = await assignRes.json();
          if(!assignRes.ok || !assignData.success){
            // Check if it's already assigned
            if(assignRes.status === 400 && assignData.message && assignData.message.includes('already assigned')){
              btn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>Already Assigned';
              btn.classList.remove('btn-primary');
              btn.classList.add('bg-warning', 'text-white');
              lucide.createIcons();
              setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.classList.remove('bg-warning', 'text-white');
                btn.classList.add('btn-primary');
                lucide.createIcons();
              }, 2000);
              return;
            }
            throw new Error(assignData.message || assignData.error || 'Failed to assign skill');
          }

          // Success message
          btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-2"></i>Assigned!';
          btn.classList.remove('btn-primary');
          btn.classList.add('bg-success', 'text-white');
          lucide.createIcons();

          // Reset button after 2 seconds
          setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.classList.remove('bg-success', 'text-white');
            btn.classList.add('btn-primary');
            lucide.createIcons();
          }, 2000);

        }catch(err){
          alert(err.message || 'Failed to assign skill. Please try again.');
          btn.disabled = false;
          btn.innerHTML = originalText;
          lucide.createIcons();
        }
      }

      if(assignBtn){
        assignBtn.addEventListener('click', assignSkillToLearner);
      }

      function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      searchEl && searchEl.addEventListener('input', debounce((e) => renderSkills(skillsData, e.target.value), 180));

      fetchSkills();
    })();
  </script>
</section>