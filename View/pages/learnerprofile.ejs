<%- include('../includes/head') %> 
<%
  // Set default values for variables that might not be passed
  const _learner = typeof learner !== 'undefined' ? learner : null;
  const _stats = typeof stats !== 'undefined' ? stats : { currentXP: 0, nextLevelXP: 1000, xpProgress: 0, xpToNextLevel: 1000, streak: 0, completedQuizzes: 0, totalQuizzes: 0, completionPercent: 0, remainingQuizzes: 0 };
  const _badges = typeof badges !== 'undefined' ? badges : [];
  const _skills = typeof skills !== 'undefined' ? skills : [];
  const _results = typeof results !== 'undefined' ? results : [];
%>
<% if (!user || user.Role !== "Learner") { %>
<script>
  location.href = "/api/v1/auth/?tab=login";
</script>
<% } %>

<div class="min-h-screen px-4 py-8">
  <div class="max-w-6xl mx-auto space-y-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="p-3 bg-primary/20 rounded-2xl">
          <i data-lucide="zap" class="w-6 h-6 text-primary"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-foreground">My Profile</h1>
          <p class="text-muted-foreground"><%= user ? user.Email : '' %></p>
        </div>
      </div>
      <a
        href="/api/v1/logout"
        class="inline-flex items-center px-3 py-2 rounded-md border border-border"
      >
        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
      </a>
    </div>

    <div class="grid gap-4 md:grid-cols-3">
      <div class="bg-gradient-card border border-border shadow-card rounded-xl">
        <div class="px-6 py-4 border-b border-border/50">
          <div class="text-sm flex items-center gap-2 text-muted-foreground">
            <i data-lucide="trending-up" class="w-4 h-4"></i>
            Level Progress
          </div>
        </div>
        <div class="p-6 space-y-3">
          <div class="flex items-baseline gap-2">
            <span class="text-3xl font-bold text-foreground"><%= _learner ? _learner.Level : 'Beginner' %></span>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">XP</span>
              <span class="font-semibold text-foreground"><%= _stats.currentXP %> / <%= _stats.nextLevelXP %></span>
            </div>
            <div class="w-full h-2 bg-white/10 rounded">
              <div class="h-2 bg-primary rounded" style="width: <%= _stats.xpProgress %>%"></div>
            </div>
          </div>
          <p class="text-xs text-muted-foreground"><%= _stats.xpToNextLevel %> XP to next level</p>
        </div>
      </div>

      <div class="bg-gradient-card border border-border shadow-card rounded-xl">
        <div class="px-6 py-4 border-b border-border/50">
          <div class="text-sm flex items-center gap-2 text-muted-foreground">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Current Streak
          </div>
        </div>
        <div class="p-6 space-y-3">
          <div class="flex items-baseline gap-2">
            <span class="text-3xl font-bold text-warning"><%= _stats.streak %></span>
            <span class="text-lg text-muted-foreground">days</span>
          </div>
          <div class="flex items-center gap-1 text-sm text-muted-foreground">
            <i data-lucide="flame" class="w-4 h-4 text-warning"></i>
            <span><%= _stats.streak > 0 ? 'Keep it going!' : 'Start your streak!' %></span>
          </div>
          <p class="text-xs text-muted-foreground">
            Complete a quiz daily to maintain your streak
          </p>
        </div>
      </div>

      <div class="bg-gradient-card border border-border shadow-card rounded-xl">
        <div class="px-6 py-4 border-b border-border/50">
          <div class="text-sm flex items-center gap-2 text-muted-foreground">
            <i data-lucide="target" class="w-4 h-4"></i>
            Quiz Completion
          </div>
        </div>
        <div class="p-6 space-y-3">
          <div class="flex items-baseline gap-2">
            <span class="text-3xl font-bold text-success"><%= _stats.completionPercent %>%</span>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">Completed</span>
              <span class="font-semibold text-foreground"><%= _stats.completedQuizzes %> / <%= _stats.totalQuizzes %></span>
            </div>
            <div class="w-full h-2 bg-white/10 rounded">
              <div class="h-2 bg-secondary rounded" style="width: <%= _stats.completionPercent %>%"></div>
            </div>
          </div>
          <p class="text-xs text-muted-foreground"><%= _stats.remainingQuizzes %> quizzes remaining</p>
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <div>
        <div class="grid grid-cols-3 max-w-md gap-2">
          <button
            data-tab="badges"
            data-group="profile-tabs"
            class="px-3 py-2 rounded-md bg-card shadow-sm"
          >
            <i data-lucide="trophy" class="w-4 h-4 mr-1 inline"></i> Badges
          </button>
          <button
            data-tab="skills"
            data-group="profile-tabs"
            class="px-3 py-2 rounded-md text-muted-foreground"
          >
            <i data-lucide="book-open" class="w-4 h-4 mr-1 inline"></i> Skills
          </button>
          <button
            data-tab="results"
            data-group="profile-tabs"
            class="px-3 py-2 rounded-md text-muted-foreground"
          >
            <i data-lucide="bar-chart-3" class="w-4 h-4 mr-1 inline"></i>
            Results
          </button>
        </div>
      </div>

      <div data-tab-content="badges" data-group="profile-tabs">
        <div
          class="bg-gradient-card border border-border shadow-card rounded-xl"
        >
          <div class="px-6 py-4 border-b border-border/50">
            <h3 class="text-foreground font-semibold">Your Achievements</h3>
          </div>
          <div class="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <%
              const badgeCfg = {
                bronze: {text: 'text-badge-bronze', bg: 'bg-badge-bronze/20', border: 'border-badge-bronze/40', glow: 'shadow-[0_0_20px_hsl(var(--badge-bronze)/0.4)]'},
                silver: {text: 'text-badge-silver', bg: 'bg-badge-silver/20', border: 'border-badge-silver/40', glow: 'shadow-[0_0_20px_hsl(var(--badge-silver)/0.4)]'},
                gold: {text: 'text-badge-gold', bg: 'bg-badge-gold/20', border: 'border-badge-gold/40', glow: 'shadow-[0_0_20px_hsl(var(--badge-gold)/0.4)]'},
                special: {text: 'text-badge-special', bg: 'bg-badge-special/20', border: 'border-badge-special/40', glow: 'shadow-[0_0_30px_hsl(var(--badge-special)/0.5)]'}
              };
            %>
            <% if (_badges && _badges.length > 0) { %>
              <% _badges.forEach(function(b) {
                const badgeType = b.type || 'bronze';
                const unlocked = b.unlocked || false;
                const cfg = badgeCfg[badgeType] || badgeCfg.bronze;
                const classes = unlocked ? (cfg.border + ' ' + cfg.glow + ' hover:scale-105 cursor-pointer') : 'border-border/50 grayscale opacity-60';
              %>
              <div class="relative p-6 rounded-xl border-2 transition-all duration-300 bg-card <%= classes %>">
                <% if (unlocked) { %>
                <div class="absolute inset-0 rounded-xl opacity-10 <%= cfg.bg %>"></div>
                <% } %>
                <div class="relative flex items-start gap-4">
                  <div class="flex-shrink-0 w-16 h-16 rounded-xl flex items-center justify-center border-2 <%= unlocked ? (cfg.bg + ' ' + cfg.border) : 'bg-white/10 border-border/50' %>">
                    <i data-lucide="award" class="w-8 h-8 <%= unlocked ? cfg.text : 'text-muted-foreground' %>"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-lg text-foreground mb-1"><%= b.Name || b.title %></h3>
                    <p class="text-sm text-muted-foreground leading-relaxed"><%= b.Description || b.desc %></p>
                    <% if (!unlocked) { %>
                    <div class="mt-2 text-xs font-medium text-muted-foreground/80 italic">Locked</div>
                    <% } %>
                  </div>
                </div>
                <% if (unlocked && badgeType === 'special') { %>
                <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-transparent via-white/10 to-transparent animate-shimmer bg-[length:200%_100%]"></div>
                <% } %>
              </div>
              <% }); %>
            <% } else { %>
              <div class="col-span-full text-center py-8 text-muted-foreground">
                <i data-lucide="award" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                <p>No badges earned yet. Complete quizzes to earn badges!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <div class="hidden" data-tab-content="skills" data-group="profile-tabs">
        <div
          class="bg-gradient-card border border-border shadow-card rounded-xl"
        >
          <div class="px-6 py-4 border-b border-border/50">
            <h3 class="text-foreground font-semibold">Your Skills</h3>
          </div>
          <div class="p-6 space-y-4">
            <% if (_skills && _skills.length > 0) { %>
              <%
                const skillColors = ['bg-primary', 'bg-secondary', 'bg-accent', 'bg-success', 'bg-warning'];
                const categoryLevels = { 'Beginner': 33, 'Intermediate': 66, 'Expert': 100 };
              %>
              <% _skills.forEach(function(s, index) {
                const barColor = skillColors[index % skillColors.length];
                const levelPercent = categoryLevels[s.category] || 33;
              %>
              <div class="space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-foreground font-medium"><%= s.skillName %></span>
                  <span class="text-muted-foreground"><%= s.category %></span>
                </div>
                <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                  <div class="h-full <%= barColor %>" style="width: <%= levelPercent %>%"></div>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="text-center py-8 text-muted-foreground">
                <i data-lucide="book-open" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                <p>No skills tracked yet. Complete assessments to build your skills!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <div class="hidden" data-tab-content="results" data-group="profile-tabs">
        <div
          class="bg-gradient-card border border-border shadow-card rounded-xl"
        >
          <div class="px-6 py-4 border-b border-border/50">
            <h3 class="text-foreground font-semibold">Recent Quiz Results</h3>
          </div>
          <div class="p-6 space-y-3">
            <% if (_results && _results.length > 0) { %>
              <% _results.forEach(function(r) {
                const scorePercent = r.totalQuestions > 0 ? Math.round((r.score / r.totalQuestions) * 100) : 0;
                const scoreColor = scorePercent >= 80 ? 'text-success' : (scorePercent >= 50 ? 'text-warning' : 'text-destructive');
                const xpEarned = r.passed ? '+' + (scorePercent * 2) + ' XP' : '0 XP';
              %>
              <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                <div>
                  <p class="font-medium text-foreground"><%= r.courseId ? (r.courseId.Title || 'Assessment') : 'Assessment' %></p>
                  <p class="text-sm text-muted-foreground">
                    <% if (r.submittedAt) { %>
                      Completed <%= new Date(r.submittedAt).toLocaleDateString() %>
                    <% } else { %>
                      <%= r.status %>
                    <% } %>
                  </p>
                </div>
                <div class="text-right">
                  <p class="text-lg font-bold <%= scoreColor %>"><%= scorePercent %>%</p>
                  <p class="text-xs text-muted-foreground"><%= xpEarned %></p>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="text-center py-8 text-muted-foreground">
                <i data-lucide="bar-chart-3" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                <p>No quiz results yet. Take an assessment to see your progress!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../includes/footer') %>
