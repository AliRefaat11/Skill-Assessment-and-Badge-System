<%- include('../includes/head') %>

<div class="min-h-screen flex items-center justify-center px-4 py-12">
  <div class="w-full max-w-md">
    <!-- toast placeholder -->
    <div id="toast" class="toast hidden">
      <span class="badge">Password</span>
      <span
        >Must be at least 8 characters and include letters and numbers.</span
      >
    </div>
    <div class="text-center mb-8">
      <div class="inline-flex items-center gap-2 mb-2">
        <i data-lucide="zap" class="w-8 h-8 text-primary"></i>
        <span
          class="text-2xl font-extrabold brand-gradient tracking-wide select-none"
          >Rankify</span
        >
      </div>
    </div>
    <div
      class="bg-card/60 backdrop-blur border-gradient rounded-2xl p-8 glossy"
    >
      <h2 class="text-3xl font-bold text-center text-foreground mb-2">
        Welcome Back
      </h2>
      <p class="text-center text-muted-foreground mb-8">
        Sign in to continue your learning journey
      </p>

      <div class="flex gap-2 mb-6 bg-white/10 p-1 rounded-lg">
        <button
          id="tab-login"
          data-tab="login"
          data-group="auth"
          class="flex-1 py-2 px-4 rounded-md font-medium"
        >
          Login
        </button>
        <button
          id="tab-signup"
          data-tab="signup"
          data-group="auth"
          class="flex-1 py-2 px-4 rounded-md font-medium text-muted-foreground"
        >
          Sign Up
        </button>
      </div>

      <form
        method="post"
        action="/api/v1/auth/login"
        class="space-y-4"
        data-tab-content="login"
        data-group="auth"
      >
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="email">Email</label>
          <input
            id="email"
            name="Email"
            type="email"
            placeholder="you@example.com"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
            pattern="^[A-Za-z][^@\s]*@[A-Za-z][^\s@]*$"
            title="Email must have letters before and after @"
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="password">Password</label>
          <input
            id="password"
            name="Password"
            type="password"
            placeholder="••••••••"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <button
          type="submit"
          class="w-full bg-primary hover:opacity-90 text-white rounded-md px-4 py-2 shadow-glow"
        >
          Login
        </button>
      </form>

      <form
        method="post"
        action="/api/v1/auth/signup"
        class="space-y-4 hidden"
        data-tab-content="signup"
        data-group="auth"
      >
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="first_name"
            >First Name</label
          >
          <input
            id="first_name"
            name="FName"
            type="text"
            placeholder="John"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="last_name"
            >Last Name</label
          >
          <input
            id="last_name"
            name="LName"
            type="text"
            placeholder="Doe"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="email2">Email</label>
          <input
            id="email2"
            name="Email"
            type="email"
            placeholder="you@example.com"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="password2"
            >Password</label
          >
          <input
            id="password2"
            name="Password"
            type="password"
            placeholder="••••••••"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="passwordComfirm">Confirm Password</label>
          <input
            id="passwordComfirm"
            name="passwordComfirm"
            type="password"
            placeholder="••••••••"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="PhoneNumber">Phone Number</label>
          <input
            id="PhoneNumber"
            name="PhoneNumber"
            type="tel"
            placeholder="1234567890"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="Gender">Gender</label>
          <select
            id="Gender"
            name="Gender"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          >
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="text-foreground text-sm" for="dateOfBirth">Date of Birth</label>
          <input
            id="dateOfBirth"
            name="dateOfBirth"
            type="date"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          />
        </div>
        <label class="text-foreground text-sm" for="level">Level</label>
        <select
            id="level"
            name="level"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          >
            <option value="">Select Level</option>
            <option value="Beginner">Beginner</option>
            <option value="Intermediate">Intermediate</option>
            <option value="Advanced">Advanced</option>
          </select>
          <label class="text-foreground text-sm" for="education">Education</label>
          <select
            id="education"
            name="education"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          >
            <option value="">Select Education</option>
            <option value="High School">High School</option>
            <option value="Bachelor">Bachelor</option>
            <option value="Master">Master</option>
            <option value="Doctorate">Doctorate</option>
            <option value="Other">Other</option>
          </select>

        <div class="space-y-2">
          <label class="text-foreground text-sm" for="skillId">Field of Interest</label>
          <select
            id="skillId"
            name="skillId"
            class="w-full bg-background/50 border border-border rounded-md px-3 py-2 input"
            required
          >
            <option value="">Loading skills...</option>
          </select>
        </div>

        <button
          type="submit"
          class="w-full bg-primary hover:opacity-90 text-white rounded-md px-4 py-2 shadow-glow"
        >
          Sign Up
        </button>
      </form>

      <p class="text-center text-sm text-muted-foreground mt-6">
        By continuing, you agree to our Terms of Service and Privacy Policy
      </p>
    </div>
  </div>
</div>

<script>
  (function () {
    const tabs = document.querySelectorAll('[data-tab][data-group="auth"]');
    const contents = document.querySelectorAll('[data-tab-content][data-group="auth"]');

    // Fetch skills from database and populate dropdown
    async function loadSkills() {
      const skillSelect = document.getElementById('skillId');
      try {
        const res = await fetch('/api/v1/skill');
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const skills = await res.json();
        
        skillSelect.innerHTML = '<option value="">Select a Skill</option>';
        
        // Handle both array and { data: array } formats
        const skillsArray = Array.isArray(skills) ? skills : (skills.data || []);
        
        if (skillsArray.length > 0) {
          // Group skills by category
          const skillsByCategory = {};
          skillsArray.forEach(skill => {
            if (!skillsByCategory[skill.category]) {
              skillsByCategory[skill.category] = [];
            }
            skillsByCategory[skill.category].push(skill);
          });
          
          // Create optgroups for each category
          Object.keys(skillsByCategory).sort().forEach(category => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category;
            
            skillsByCategory[category].forEach(skill => {
              const option = document.createElement('option');
              option.value = skill._id;
              option.textContent = skill.skillName;
              optgroup.appendChild(option);
            });
            
            skillSelect.appendChild(optgroup);
          });
        } else {
          skillSelect.innerHTML = '<option value="">No skills available</option>';
        }
      } catch (err) {
        console.error('Failed to load skills:', err);
        console.error('Error details:', err.message);
        skillSelect.innerHTML = '<option value="">Failed to load skills. Please refresh the page.</option>';
      }
    }
    
    // Load skills when page loads
    loadSkills();

    function openTab(name) {
      // Update tab styles (only for login/signup)
      tabs.forEach(t => {
        const active = t.dataset.tab === name;
        t.classList.toggle('bg-primary', active);
        t.classList.toggle('text-white', active);
        t.classList.toggle('text-muted-foreground', !active);
      });

      // Toggle forms
      contents.forEach(c => {
        c.classList.toggle('hidden', c.dataset.tabContent !== name);
      });
    }

    // Tab clicks
    tabs.forEach(tab => {
      tab.addEventListener('click', () => openTab(tab.dataset.tab));
    });

    // URL-driven behavior
    const params = new URLSearchParams(location.search);

    openTab(params.get("tab") === "signup" ? "signup" : "login");

    if (params.get("error") === "pw") {
      const toast = document.getElementById("toast");
      if (toast) {
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 4000);
      }
    }

    // Handle login form submission
    const loginForm = document.querySelector('[data-tab-content="login"]');
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(loginForm);
      const data = Object.fromEntries(formData.entries());
      
      try {
        const res = await fetch('/api/v1/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.status === 'success') {
          // Store token in localStorage
          localStorage.setItem('token', result.token);
          localStorage.setItem('role', result.role);
          
          // Redirect based on role
          if (result.role === 'Learner') {
            window.location.href = '/api/v1/learner/profile';
          } else if (result.role === 'Instructor') {
            window.location.href = '/api/v1/instructor/profile';
          } else if (result.role === 'Admin') {
            window.location.href = '/api/v1/admin';
          } else {
            window.location.href = '/';
          }
        } else {
          alert(result.message || 'Login failed');
        }
      } catch (err) {
        alert('Login failed. Please try again.');
      }
    });

    // Handle signup form submission
    const signupForm = document.querySelector('[data-tab-content="signup"]');
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(signupForm);
      const data = Object.fromEntries(formData.entries());
      
      // Check password confirmation
      if (data.Password !== data.passwordComfirm) {
        alert('Passwords do not match');
        return;
      }
      
      try {
        const res = await fetch('/api/v1/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.status === 'success') {
          localStorage.setItem('token', result.token);
          localStorage.setItem('role', 'Learner');
          window.location.href = '/api/v1/learner/profile';
        } else {
          alert(result.message || 'Signup failed');
        }
      } catch (err) {
        alert('Signup failed. Please try again.');
      }
    });
  })();
</script>

<%- include('../includes/footer') %>